

<html>

  <head></head>

  <body>
      <script id="can_spread_its_DNA_into_DB">


        // In the following line, you should include the prefixes of implementations you want to test.
        window.indexedDB = window.indexedDB || window.mozIndexedDB || window.webkitIndexedDB || window.msIndexedDB;

        // DON'T use "var indexedDB = ..." if you're not in a function.
        // Moreover, you may need references to some window.IDB* objects:
        window.IDBTransaction = window.IDBTransaction || window.webkitIDBTransaction || window.msIDBTransaction || {READ_WRITE: "readwrite"};// This line should only be needed if it is needed to support the object's constants for older browsers

        window.IDBKeyRange = window.IDBKeyRange || window.webkitIDBKeyRange || window.msIDBKeyRange;
// (Mozilla has never prefixed these objects, so we don't need window.mozIDB*)


<!---------------------------- STREAM ENTRY -------------------------------->

        if (!window.indexedDB)
        {
          console.log("Your browser doesn't support a stable version of IndexedDB. Such and such feature will not be available.");
        }

        function generateUUID()
        {
          const array = new Uint16Array(16);
          const idBuffer = window.crypto.getRandomValues(array);
          const str = Array.prototype.map.call(new Uint8Array(idBuffer), x => ('00' + x.toString(16)).slice(-2)).join('');

          return str;
        }

        // Let us open our database
        var DBOpenRequest = window.indexedDB.open("the_shared_memory");

        // these two event handlers act on the IDBDatabase object,
        // when the database is opened successfully, or not
        DBOpenRequest.onerror = function(event) {
          alert('Error loading database!');
        };

        DBOpenRequest.onsuccess = function(event) {
            alert('Database is initialized and open!');

          // store the result of opening the database in the db
          // variable. This is used a lot later on
          db = DBOpenRequest.result;



          var doc1 = {
            "$id": "null",
            "subject_id": null,
            "creator_id": null,
            "payload": null,
            "t": 0
          }

        // open a read/write db transaction, ready for adding the data
         var transaction = db.transaction(['null'], 'readwrite');


        // report on the success of the transaction completing, when everything is done
        transaction.oncomplete = function(event) {
          alert('Transaction completed.');
        };

        transaction.onerror = function(event) {
          alert('Transaction not opened due to error. Duplicate items not allowed.');
        };

        // create an object store on the transaction
        var objectStore = transaction.objectStore('null');

        // Make a request to add our newItem object to the object store
        var objectStoreRequest = objectStore.add(doc1);

        objectStoreRequest.onsuccess = function(event) {
          // report the success of our request
          alert('Request successful');
        };

        var doc1 = {
          "$id": "null",
          "subject_id": null,
          "creator_id": null,
          "payload": null,
          "t": 0
        };

        // This event handles the event whereby a new version of
        // the database needs to be created Either one has not
        // been created before, or a new version number has been
        // submitted via the window.indexedDB.open line above

        DBOpenRequest.onupgradeneeded = function(event) {
          var db = event.target.result;

          db.onerror = function(event) {
            alert('Error loading database!');
          };

          // Create an objectStore for this database using
          // IDBDatabase.createObjectStore

          var objectStore = db.createObjectStore("null", { keyPath: "$id" });
          var objectStore = db.createObjectStore("stream_entry", { keyPath: "$id" });

          alert('Object store created.');

        };



/*
        function buf2hex(buffer) { // buffer is an ArrayBuffer
          return Array.prototype.map.call(new Uint8Array(buffer), x => ('00' + x.toString(16)).slice(-2)).join('');
        }
*/

        
        var newIdString1 = generateUUID();
        var newIdString2 = generateUUID();

        console.log(newIdString1 + " - " + newIdString2);

        var doc2 = {
          "$id": newIdString2,
          "subject_id": null,
          "creator_id": null,
          "payload": null,
          "t": 1
        };

        newIdString1 = generateUUID();

        var doc = {
          "$id": newIdString1,
          "subject_id": newIdString2,
          "creator_id": newIdString2,
          "payload": null,
          "t":2
        };

        newIdString1 = generateUUID();

        var doc = {
          "$id": newIdString1,
          "subject_id": newIdString1,
          "creator_id": newIdString2,
          "payload": null,
          "t": 3
        };

        var jackSong = "//https://youtu.be/_NSn5RfxoXs";



        alert("\nCAN:\nSPREAD ITS DNA\nINTO\nINDEXEDDB.\n\n");
      </script>

      <script id="can_spread_its_DNA_into_DB">
      </script>
  </body>
  </html>

    